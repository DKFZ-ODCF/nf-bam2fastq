/**
 *  Copyright (c) 2022 DKFZ.
 *
 *  Distributed under the MIT License (license terms are at https://github.com/DKFZ-ODCF/nf-bam2fastq/blob/master/LICENSE.txt).
 *
 *  Author: Philip R. Kensche
 *
 *  Configuration for the DKFZ-ODCF/nf-bam2fastq Nextflow workflow.
 */

manifest {
    homePage = 'https://github.com/DKFZ-ODCF/nf-bam2fastq'
    description = 'BAM-to-FASTQ conversion and FASTQ-sorting workflow'
    mainScript = 'main.nf'
    version = '1.2.0'
    author = 'Philip Reiner Kensche'
    nextflowVersion = '>= 22.07.1'
}

// The workflow may refer to an older container version, e.g. if the container was not updated.
ext.containerVersion = '1.0.0'
ext.containerUrl = "docker://ghcr.io/dkfz-odcf/nf-bam2fastq:${ext.containerVersion}"
ext.taskEnvYaml = "${projectDir}/task-environment.yml"

profiles {

    // It seems the `container` field is not used in the "lsf" profile, unless it is explicitly
    // added as to the "lsf" block. I added it to all relevant "process" blocks. Whether it is
    // going to be used, will depend on the `enabled` toggles in the `docker` and `singularity`
    // profiles.

    test {
        process {
            cpus = 1
            memory = 1.GB
            container = ext.containerUrl
        }
    }

    local {
        process {
            executor = 'local'
            container = ext.containerUrl
        }
    }

    conda {
        conda.enabled = true
        conda.cacheDir = "${projectDir}/cache/conda"
    }

    mamba {
        conda.enabled = true
        useMamba = true
        conda.cacheDir = "${projectDir}/cache/conda"
    }

    docker {
        docker.enabled = true
        docker.runOptions='-u $(id -u):$(id -g)'
    }

    singularity {
        // Automatically pull the Docker image, and put it into the cache directory
        singularity.enabled = true
        singularity.cacheDir = "${projectDir}/cache/singularity"
        // The singularity containers are stored in the workflow-directory
        singularity.autoMounts = true
        // Don't mount the home directory by default, because Bash may setup the environment from
        // there thus breaking the environment encapsulation and reproducibility of the workflow.
        singularity.runOptions = "--no-home"
    }

    lsf {
        process {
            executor = 'lsf'
            clusterOptions = '-env none'
            container = ext.containerUrl
        }
        executor {
            // scratch = '$SCRATCHDIR/$LSB_JOBID'
            perTaskReserve = false
            perJobMemLimit = true
        }
    }

}

/**  Use the following to configure e.g. submission limits, job-names, etc. for the executor. See
 *
 * https://www.nextflow.io/docs/latest/config.html?highlight=jobname#scope-executor
 */
executor {
    jobName = { "nf-bam2fastq - $task.name - $task.hash" }
}

